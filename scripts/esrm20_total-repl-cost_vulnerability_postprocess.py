#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Sat Jul 17 19:04:01 2021

@author: helencrowley
"""
import glob
import os
import pandas as pd
import numpy as np
from scipy import stats


#%% read list of typologies from capacity curves

current_dir=os.getcwd()
cap_in_files=glob.glob(os.path.join(os.path.join(current_dir,'../ESRM20_capacity_curves','*.csv')))
cap_in_files=sorted(cap_in_files)

#%% read fragility data

fragility_PGA = pd.read_excel('../esrm20_fragility_various_IM_lognormal.xlsx',sheet_name='PGA')
fragility_SA03 = pd.read_excel('../esrm20_fragility_various_IM_lognormal.xlsx',sheet_name='SA(0.3s)')
fragility_SA06 = pd.read_excel('../esrm20_fragility_various_IM_lognormal.xlsx',sheet_name='SA(0.6s)')
fragility_SA10 = pd.read_excel('../esrm20_fragility_various_IM_lognormal.xlsx',sheet_name='SA(1.0s)')
fragility_final = pd.read_excel('../esrm20_fragility_various_IM_lognormal.xlsx',sheet_name='Final')
fragility_ShakeMap = pd.read_excel('../esrm20_fragility_various_IM_lognormal.xlsx',sheet_name='ShakeMap')

#%%  damage-loss model for replacement cost

#dam2loss=[0.02, 0.1, 0.5, 1]
dam2loss=[0.05, 0.15, 0.6, 1]


#%% calculate vulnerability for all IMs

vuln_PGA = np.zeros([len(cap_in_files),50])
vuln_SA03 = np.zeros([len(cap_in_files),50])
vuln_SA06 = np.zeros([len(cap_in_files),50])
vuln_SA10 = np.zeros([len(cap_in_files),50])
Class = np.empty([len(cap_in_files)],dtype='<U25')
for k in range(len(cap_in_files)):
    cap_file=cap_in_files[k]
    building_class=cap_file.split('/')[-1].split('\\')[-1].split('.')[0][10:]
    Class[k] = building_class
    x_vec = np.linspace(np.log(0.01),np.log(5),endpoint=True)
    #PGA
    med1 =  fragility_PGA[fragility_PGA['Typology']==building_class]['Median_DS1']
    med2 =  fragility_PGA[fragility_PGA['Typology']==building_class]['Median_DS2']
    med3 =  fragility_PGA[fragility_PGA['Typology']==building_class]['Median_DS3']
    med4 =  fragility_PGA[fragility_PGA['Typology']==building_class]['Median_DS4']
    beta =  fragility_PGA[fragility_PGA['Typology']==building_class]['Beta']
    
    probability_damage_state_PGA1=np.zeros(len(x_vec))
    probability_damage_state_PGA2=np.zeros(len(x_vec))
    probability_damage_state_PGA3=np.zeros(len(x_vec))
    probability_damage_state_PGA4=np.zeros(len(x_vec))
    for i in range(len(x_vec)):       
        probability_damage_state_PGA1[i]=stats.norm.cdf(x_vec[i],loc=np.log(med1),scale=beta) 
        probability_damage_state_PGA2[i]=stats.norm.cdf(x_vec[i],loc=np.log(med2),scale=beta)
        probability_damage_state_PGA3[i]=stats.norm.cdf(x_vec[i],loc=np.log(med3),scale=beta)
        probability_damage_state_PGA4[i]=stats.norm.cdf(x_vec[i],loc=np.log(med4),scale=beta)
            
    vuln_PGA[k,:]= dam2loss[0]*(probability_damage_state_PGA1[:]-probability_damage_state_PGA2[:]) + \
    dam2loss[1]*(probability_damage_state_PGA2[:]-probability_damage_state_PGA3[:]) + \
    dam2loss[2]*(probability_damage_state_PGA3[:]-probability_damage_state_PGA4[:]) + \
    dam2loss[3]*(probability_damage_state_PGA4[:])
    
#%%    
    #SA03
    med1 =  fragility_SA03[fragility_SA03['Typology']==building_class]['Median_DS1']
    med2 =  fragility_SA03[fragility_SA03['Typology']==building_class]['Median_DS2']
    med3 =  fragility_SA03[fragility_SA03['Typology']==building_class]['Median_DS3']
    med4 =  fragility_SA03[fragility_SA03['Typology']==building_class]['Median_DS4']
    beta =  fragility_SA03[fragility_SA03['Typology']==building_class]['Beta']
    
    probability_damage_state_SA031=np.zeros(len(x_vec))
    probability_damage_state_SA032=np.zeros(len(x_vec))
    probability_damage_state_SA033=np.zeros(len(x_vec))
    probability_damage_state_SA034=np.zeros(len(x_vec))
    for i in range(len(x_vec)):       
        probability_damage_state_SA031[i]=stats.norm.cdf(x_vec[i],loc=np.log(med1),scale=beta) 
        probability_damage_state_SA032[i]=stats.norm.cdf(x_vec[i],loc=np.log(med2),scale=beta)
        probability_damage_state_SA033[i]=stats.norm.cdf(x_vec[i],loc=np.log(med3),scale=beta)
        probability_damage_state_SA034[i]=stats.norm.cdf(x_vec[i],loc=np.log(med4),scale=beta)
            
    vuln_SA03[k,:]= dam2loss[0]*(probability_damage_state_SA031[:]-probability_damage_state_SA032[:]) + \
    dam2loss[1]*(probability_damage_state_SA032[:]-probability_damage_state_SA033[:]) + \
    dam2loss[2]*(probability_damage_state_SA033[:]-probability_damage_state_SA034[:]) + \
    dam2loss[3]*(probability_damage_state_SA034[:])
    
    #SA06
    med1 =  fragility_SA06[fragility_SA06['Typology']==building_class]['Median_DS1']
    med2 =  fragility_SA06[fragility_SA06['Typology']==building_class]['Median_DS2']
    med3 =  fragility_SA06[fragility_SA06['Typology']==building_class]['Median_DS3']
    med4 =  fragility_SA06[fragility_SA06['Typology']==building_class]['Median_DS4']
    beta =  fragility_SA06[fragility_SA06['Typology']==building_class]['Beta']
    
    probability_damage_state_SA061=np.zeros(len(x_vec))
    probability_damage_state_SA062=np.zeros(len(x_vec))
    probability_damage_state_SA063=np.zeros(len(x_vec))
    probability_damage_state_SA064=np.zeros(len(x_vec))
    for i in range(len(x_vec)):       
        probability_damage_state_SA061[i]=stats.norm.cdf(x_vec[i],loc=np.log(med1),scale=beta) 
        probability_damage_state_SA062[i]=stats.norm.cdf(x_vec[i],loc=np.log(med2),scale=beta)
        probability_damage_state_SA063[i]=stats.norm.cdf(x_vec[i],loc=np.log(med3),scale=beta)
        probability_damage_state_SA064[i]=stats.norm.cdf(x_vec[i],loc=np.log(med4),scale=beta)
            
    vuln_SA06[k,:]= dam2loss[0]*(probability_damage_state_SA061[:]-probability_damage_state_SA062[:]) + \
    dam2loss[1]*(probability_damage_state_SA062[:]-probability_damage_state_SA063[:]) + \
    dam2loss[2]*(probability_damage_state_SA063[:]-probability_damage_state_SA064[:]) + \
    dam2loss[3]*(probability_damage_state_SA064[:])
            
    #SA10
    med1 =  fragility_SA06[fragility_SA10['Typology']==building_class]['Median_DS1']
    med2 =  fragility_SA06[fragility_SA10['Typology']==building_class]['Median_DS2']
    med3 =  fragility_SA06[fragility_SA10['Typology']==building_class]['Median_DS3']
    med4 =  fragility_SA06[fragility_SA10['Typology']==building_class]['Median_DS4']
    beta =  fragility_SA06[fragility_SA10['Typology']==building_class]['Beta']
    
    probability_damage_state_SA101=np.zeros(len(x_vec))
    probability_damage_state_SA102=np.zeros(len(x_vec))
    probability_damage_state_SA103=np.zeros(len(x_vec))
    probability_damage_state_SA104=np.zeros(len(x_vec))
    for i in range(len(x_vec)):       
        probability_damage_state_SA101[i]=stats.norm.cdf(x_vec[i],loc=np.log(med1),scale=beta) 
        probability_damage_state_SA102[i]=stats.norm.cdf(x_vec[i],loc=np.log(med2),scale=beta)
        probability_damage_state_SA103[i]=stats.norm.cdf(x_vec[i],loc=np.log(med3),scale=beta)
        probability_damage_state_SA104[i]=stats.norm.cdf(x_vec[i],loc=np.log(med4),scale=beta)
            
    vuln_SA10[k,:]= dam2loss[0]*(probability_damage_state_SA101[:]-probability_damage_state_SA102[:]) + \
    dam2loss[1]*(probability_damage_state_SA102[:]-probability_damage_state_SA103[:]) + \
    dam2loss[2]*(probability_damage_state_SA103[:]-probability_damage_state_SA104[:]) + \
    dam2loss[3]*(probability_damage_state_SA104[:])
    
#%% write Excel sheets for viewer

out_PGA = pd.DataFrame(vuln_PGA)
out_SA03 = pd.DataFrame(vuln_SA03)
out_SA06 = pd.DataFrame(vuln_SA06)
out_SA10 = pd.DataFrame(vuln_SA10)
imls_PGA = pd.DataFrame(np.exp(x_vec), columns=['PGA'])
imls_SA03 = pd.DataFrame(np.exp(x_vec), columns=['SA(0.3s)'])
imls_SA06 = pd.DataFrame(np.exp(x_vec), columns=['SA(0.6s)'])
imls_SA10 = pd.DataFrame(np.exp(x_vec), columns=['SA(1.0s)'])

typ = pd.DataFrame(Class)

writer=pd.ExcelWriter('../esrm20_vulnerability_total-repl-cost.xlsx', engine='xlsxwriter')    
imls_PGA.to_excel(writer,sheet_name='PGA', header=True, index=False, startrow=0, startcol=0)
typ.T.to_excel(writer,sheet_name='PGA', header=False, index=False, startrow=0, startcol=1)
out_PGA.T.to_excel(writer,sheet_name='PGA', header=False, index=False, startrow=1, startcol=1)
imls_SA03.to_excel(writer,sheet_name='SA(0.3s)', header=True, index=False, startrow=0, startcol=0)
typ.T.to_excel(writer,sheet_name='SA(0.3s)', header=False, index=False, startrow=0, startcol=1)
out_SA03.T.to_excel(writer,sheet_name='SA(0.3s)', header=False, index=False, startrow=1, startcol=1)
imls_SA06.to_excel(writer,sheet_name='SA(0.6s)', header=True, index=False, startrow=0, startcol=0)
typ.T.to_excel(writer,sheet_name='SA(0.6s)', header=False, index=False, startrow=0, startcol=1)
out_SA06.T.to_excel(writer,sheet_name='SA(0.6s)', header=False, index=False, startrow=1, startcol=1)
imls_SA10.to_excel(writer,sheet_name='SA(1.0s)', header=True, index=False, startrow=0, startcol=0)
typ.T.to_excel(writer,sheet_name='SA(1.0s)', header=False, index=False, startrow=0, startcol=1)
out_SA10.T.to_excel(writer,sheet_name='SA(1.0s)', header=False, index=False, startrow=1, startcol=1)

writer.save()

#%% xml code generation for replacement cost, most efficient intensity measures

from xml.dom import minidom

doc = minidom.Document()

nrml=doc.createElement('nrml')
nrml.setAttribute('xmlns','http://openquake.org/xmlns/nrml/0.5')
doc.appendChild(nrml)

vulnerabilityModel = doc.createElement('vulnerabilityModel')
vulnerabilityModel.setAttribute('id','vm-global')
vulnerabilityModel.setAttribute('assetCategory','buildings')
vulnerabilityModel.setAttribute('lossCategory','structural')
nrml.appendChild(vulnerabilityModel)

description=doc.createElement('description')
text_d=doc.createTextNode('ESRM20 total replacement cost vulnerability model for Europe in terms of various SA')
description.appendChild(text_d)
vulnerabilityModel.appendChild(description)


for x in range(len(cap_in_files)):
    
    imt = fragility_final.IMT.iloc[x]
          
    imls2=np.exp(x_vec)
    if imt == 'PGA':
        vul_mean= vuln_PGA[x]
    elif imt == 'SA(0.3)':
        vul_mean = vuln_SA03[x]
    elif imt == 'SA(0.6)':
        vul_mean = vuln_SA06[x]
    else:
        vul_mean = vuln_SA10[x]
    
    s=" "
    imls_chain=s.join([str(i) for i in imls2])
    vul_mean_chain=s.join([str(i) for i in vul_mean])
           
    vulnerabilityFunction = doc.createElement('vulnerabilityFunction')
    vulnerabilityFunction.setAttribute('id',fragility_final['Typology'].iloc[x])
    
    vulnerabilityFunction.setAttribute('dist','LN')
    vulnerabilityModel.appendChild(vulnerabilityFunction)
    
    imls = doc.createElement('imls')
    text = doc.createTextNode(imls_chain)
    imls.appendChild(text)
    imls.setAttribute('imt', imt)
    vulnerabilityFunction.appendChild(imls)
    
    meanLRs = doc.createElement('meanLRs')
    text = doc.createTextNode(vul_mean_chain)
    meanLRs.appendChild(text)
    vulnerabilityFunction.appendChild(meanLRs)
       
                
    prob=np.zeros((1,50))
    s=" "
    prob_chain=s.join([str(i) for i in np.ravel(np.around(prob,6))])
    covLRs = doc.createElement('covLRs')
    text = doc.createTextNode(prob_chain)
    covLRs.appendChild(text)
    vulnerabilityFunction.appendChild(covLRs)

        
    xml_str = doc.toprettyxml(indent="")

    
    with open("vulnerability_total-repl-cost_ESRM20_VariousIM.xml", "w") as f:
        f.write(xml_str)
    
        
#%% xml code generation for replacement cost, ShakeMap intensity measures

from xml.dom import minidom

doc = minidom.Document()

nrml=doc.createElement('nrml')
nrml.setAttribute('xmlns','http://openquake.org/xmlns/nrml/0.5')
doc.appendChild(nrml)

vulnerabilityModel = doc.createElement('vulnerabilityModel')
vulnerabilityModel.setAttribute('id','vm-global')
vulnerabilityModel.setAttribute('assetCategory','buildings')
vulnerabilityModel.setAttribute('lossCategory','structural')
nrml.appendChild(vulnerabilityModel)

description=doc.createElement('description')
text_d=doc.createTextNode('ERM20 total replacement cost vulnerability model for Europe in terms of ShakeMap intensity measures')
description.appendChild(text_d)
vulnerabilityModel.appendChild(description)


for x in range(len(cap_in_files)):
    
    imt = fragility_ShakeMap.IMT.iloc[x]
          
    imls2=np.exp(x_vec)
    if imt == 'PGA':
        vul_mean= vuln_PGA[x]
    elif imt == 'SA(0.3)':
        vul_mean = vuln_SA03[x]
    elif imt == 'SA(0.6)':
        vul_mean = vuln_SA06[x]
    else:
        vul_mean = vuln_SA10[x]
    
    s=" "
    imls_chain=s.join([str(i) for i in imls2])
    vul_mean_chain=s.join([str(i) for i in vul_mean])
           
    vulnerabilityFunction = doc.createElement('vulnerabilityFunction')
    vulnerabilityFunction.setAttribute('id',fragility_final['Typology'].iloc[x])
    
    vulnerabilityFunction.setAttribute('dist','LN')
    vulnerabilityModel.appendChild(vulnerabilityFunction)
    
    imls = doc.createElement('imls')
    text = doc.createTextNode(imls_chain)
    imls.appendChild(text)
    imls.setAttribute('imt', imt)
    vulnerabilityFunction.appendChild(imls)
    
    meanLRs = doc.createElement('meanLRs')
    text = doc.createTextNode(vul_mean_chain)
    meanLRs.appendChild(text)
    vulnerabilityFunction.appendChild(meanLRs)
       
                
    prob=np.zeros((1,50))
    s=" "
    prob_chain=s.join([str(i) for i in np.ravel(np.around(prob,6))])
    covLRs = doc.createElement('covLRs')
    text = doc.createTextNode(prob_chain)
    covLRs.appendChild(text)
    vulnerabilityFunction.appendChild(covLRs)

        
    xml_str = doc.toprettyxml(indent="")

    
    with open("vulnerability_total-repl-cost_ESRM20_ShakeMapIM.xml", "w") as f:
        f.write(xml_str)
        

        